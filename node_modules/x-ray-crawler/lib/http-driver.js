/**
 * Module Dependencies
 */

var superagent = require('superagent')

/**
 * Export `driver`
 */

module.exports = driver

/**
 * Default HTTP driver
 *
 * @param {Object} opts
 * @return {Function}
 */

function driver(opts) {
  var agent = superagent.agent(opts || {})

  return function http_driver(ctx, fn) {
    agent
      .get(ctx.url)
      .set('User-Agent', 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.112 Safari/537.36')
      .set('Cookie', 'HSID=Ai-bGZwFF5jeBgQDH; SSID=AhYTN9LAdL4nVwwM6; APISID=LaIW0xG0WSpPumTy/Aja4tjIvcbjFYcEDk; SAPISID=QqFoG9IoXhVDqkpx/AEd53j-dO4aaeDbbs; OGPC=681502720-5:; SID=ywJNwE8ljcly4xFj2UgKIfgqeU6TPVSLHTYWNBp9n8F34E63HZL0pDueAeYH5cAC6bzAKA.; _ga=GA1.1.1687980686.1456237751; NID=78=oag1Ljbjmdry4kqc4miiwSpgJo_D5f_I3H5trOvAyMBctac60MG6xSB8X-Zm_UAnqqnX-uO5N43w9-E5jUUkpP5OHHKjtfVoLfKLvNoO2B7Q9uEkIkOGQrGPzTSbuEQ6nLyZnUKMJ9oe0WqpJ8RMB2LJ7NYETlOrGQrbdLSIxFUvbl8pFyaCzfk3sshVHMLTWUTz2LpK3Yv_8R79TIIOoupXGNUS5jkC58z6rULGQ_XIPErWA6vNpA; DV=QlR9p1T5e0w9PKNZ_191EwxMF8BUqLo_-HMrzeIIhgAAALa4fEbXxt3DsyoFAA')
      .end(function(err, res) {
        if (err && !err.status) return fn(err)

        ctx.status = res.status
        ctx.set(res.headers)

        ctx.body = 'application/json' == ctx.type
          ? res.body
          : res.text

        // update the URL if there were redirects
        ctx.url = res.redirects.length
          ? res.redirects.pop()
          : ctx.url

        return fn(null, ctx)
      })
  }
}
